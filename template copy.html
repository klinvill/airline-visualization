<!DOCTYPE html>
<!-- saved from url=(0056)http://mbostock.github.io/d3/talk/20111116/airports.html -->
<html><head>
  <link type="text/css" rel="stylesheet" href="style.css">
  <style type="text/css">

    g.arcs {
      pointer-events: none;
      fill: none;
      display: none;
    }

    path.arc {
      stroke: green;
      stroke-opacity: .3;
    }

    .state-boundary {
      fill: #ccc;
      stroke: #fff;
    }

    .land {
      fill: #ccc;
      stroke: #fff;
    }

    circle {
      fill: steelblue;
      fill-opacity: .8;
      stroke: #fff;
      pointer-events: all;
    }

    #cells.voronoi path.cell {
      stroke: brown;
    }

    #airports g:hover g.arcs {
      display: inherit;
    }

    
  </style>
  </head>
  <body>
    <h2> <span>O'Hare</span> <br> Airline Visualization </h2>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script type="text/javascript">

var width = 1200,
    height = 800;

var projection = d3.geo.albersUsa()
  .scale(1400)
  .translate([width / 2, height / 2 - 50]);

var path = d3.geo.path()
  .projection(projection);

var svg = d3.select("body").append("svg:svg", "h2")
  .attr("width", width)
  .attr("height", height);

var country = svg.append("svg:g")
  .attr("id", "country");

var states = svg.append("svg:g")
  .attr("id", "states");

var routes = svg.append("svg:g")
  .attr("id", "routes")

var circles = svg.append("svg:g")
  .attr("id", "airports")


//var cells = svg.append("svg:g")
//  .attr("id", "cells");

d3.json("us.json", function(error, us) {
  
  svg.selectAll("#country")
    .datum(topojson.feature(us, us.objects.land))
    .append("svg:path")
    .attr("class", "land")
    .attr("d", path);
 
  svg.selectAll("#states")
    .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
    .append("svg:path")
    .attr("class", "state-boundary")
    .attr("d", path);
});

d3.select(self.frameElement).style("height", height + "px");





d3.csv("us_flights.csv", function(flights) {
  var linksByOrigin = {},
  countByAirport = {},
  locationByAirport = {},
  positions = [];
  

  var arc = d3.geo.greatArc()
  .source(function(d) { return locationByAirport[d.source]; })
  .target(function(d) { return locationByAirport[d.target]; });


  flights.forEach(function(flight) {
                    var origin = flight.ORIGIN,
                    destination = flight.DEST,
                    airline = flight.UNIQUE_CARRIER,
                    links = linksByOrigin[origin] || (linksByOrigin[origin] = []);
                    //if(links.length > 0)
                    //  links.airlines.push(airline);
                    //else
                      links.push({source: origin, target: destination, airlines: [airline]});
                    countByAirport[origin] = (countByAirport[origin] || 0) + flight.FLIGHTS;
                    countByAirport[destination] = (countByAirport[destination] || 0) + flight.FLIGHTS;
                  });
  
  d3.csv("us_airports.csv", function(airports) {
         
    // Only consider airports with at least one flight.
    airports = airports.filter(function(airport) {
                                var location = [+airport.LONGITUDE, +airport.LATITUDE];
                                var map_loc = projection(location);
                                if (countByAirport[airport.AIRPORT] && map_loc) {
                                  locationByAirport[airport.AIRPORT] = location;
                                  positions.push(map_loc);
                                  return true;
                                }
                              });

    circles.selectAll("circle")
    .data(airports)
    .enter().append("svg:circle")
    .attr("class", "airport")
    .attr("data-airport", function(d) { return d.AIRPORT;})
    .attr("cx", function(d, i) { return positions[i][0]; })
    .attr("cy", function(d, i) { return positions[i][1]; })
    .attr("r", 3)
    .on("mouseover", function(d, i) {
        over_airport = d3.select(this).attr("data-airport");
        d3.select(this).attr("r", "5");
        d3.select("[data-airport='"+over_airport+"'").filter(".arcs").style("display", "inherit");

      })
    .on("mouseout", function(d, i) {
        over_airport = d3.select(this).attr("data-airport");
        clicked_airport = d3.select("#routes").attr("data-selected");
        d3.select(this).attr("r", "3");
        if (over_airport != clicked_airport)
          d3.select("[data-airport='"+over_airport+"'").filter(".arcs").style("display", "none");
      })
    .on("click", function(d, i) { 
        var prev_clicked =  d3.select("#routes").attr("data-selected"),
        new_clicked = d3.select(this).attr("data-airport");

        d3.select("h2 span").text(d.DISPLAY_AIRPORT_NAME);

        // Hide the routes associated with the previously selected airport
        d3.select("[data-airport='"+prev_clicked+"'").filter(".arcs").style("display", "none");
      
        d3.select("#routes").attr("data-selected", new_clicked)

        // Show the routes associated with the newly selected airport
        d3.select("[data-airport='"+new_clicked+"'").filter(".arcs").style("display", "inherit");
      });

    routes.attr("data-selected", "")
    .selectAll("g")
    .data(airports)
    .enter().append("svg:g")
    .attr("class", "arcs")
    .attr("data-airport", function(d) { return d.AIRPORT;})
   // .append("svg:g")
   // .attr("class", "sub-arcs")
    .selectAll("path.arc")
    .data(function(d) {return linksByOrigin[d.AIRPORT] || []; })
    .enter().append("svg:path")
    .attr("class", "arc")
    .attr("d", function(d) { return path(arc(d)); });
    });
  });
  
      </script>
</body>
</html>